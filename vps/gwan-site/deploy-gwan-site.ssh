#!/bin/bash

echo "ğŸ”„ Iniciando processo de deploy do gwan-site..."

SITE_PATH="/opt/gwan-site"

if [ ! -d "$SITE_PATH" ]; then
  echo "âŒ DiretÃ³rio $SITE_PATH nÃ£o encontrado!"
  exit 1
fi

cd "$SITE_PATH" || exit

# Etapa extra: mostrar versÃ£o e commit atual
if [ -f "package.json" ]; then
  VERSION=$(jq -r '.version' package.json)
  echo "ğŸ“¦ VersÃ£o atual do package.json: v$VERSION"
fi

echo "ğŸ“œ Ãšltimo commit:"
git --no-pager log -1 --pretty=format:"ğŸ”¹ %h - %s (%cr) by %an"

# Etapa 1: Preparar ambiente
echo "ğŸ“¥ Executando git pull..."
git stash save "Auto-stash antes do deploy" > /dev/null 2>&1
git pull

# Etapa 2: Instalar dependÃªncias
echo "ğŸ“¦ Instalando dependÃªncias..."
npm install

# Etapa 3: Build do projeto React
echo "âš™ï¸ Gerando build de produÃ§Ã£o..."
npm run build

# Etapa 4: Reinicia o container Docker
echo "ğŸ³ Reiniciando container Docker gwan-site..."
docker restart gwan-site

echo "âœ… Deploy finalizado com sucesso! Acesse: https://gwan.com.br"
